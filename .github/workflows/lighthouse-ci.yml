name: Lighthouse CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lighthouse:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Enable Corepack (pnpm)
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Next.js app
        run: pnpm build
        env:
          # Add any required environment variables for build
          NODE_ENV: production

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: "./lighthouserc.js"
          uploadArtifacts: true # Save results as artifacts
          temporaryPublicStorage: true # Upload results to temporary public storage
        env:
          # Optional: Add LHCI_GITHUB_APP_TOKEN for GitHub status checks
          # LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          NODE_ENV: production

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: ".lighthouseci"
          retention-days: 30

      - name: Comment PR with Lighthouse results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read the manifest file to get report URLs
            const manifestPath = '.lighthouseci/manifest.json';
            if (fs.existsSync(manifestPath)) {
              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
              
              let comment = '## ðŸ”¦ Lighthouse CI Results\n\n';
              comment += 'Lighthouse audits completed! View detailed reports:\n\n';
              
              manifest.forEach((result, index) => {
                const url = result.url || `URL ${index + 1}`;
                const summary = result.summary || {};
                
                comment += `### ${url}\n`;
                comment += '| Category | Score |\n';
                comment += '|----------|-------|\n';
                comment += `| Performance | ${summary.performance ? Math.round(summary.performance * 100) : 'N/A'} |\n`;
                comment += `| Accessibility | ${summary.accessibility ? Math.round(summary.accessibility * 100) : 'N/A'} |\n`;
                comment += `| Best Practices | ${summary['best-practices'] ? Math.round(summary['best-practices'] * 100) : 'N/A'} |\n`;
                comment += `| SEO | ${summary.seo ? Math.round(summary.seo * 100) : 'N/A'} |\n\n`;
                
                if (result.reportUrl) {
                  comment += `[ðŸ“Š View Full Report](${result.reportUrl})\n\n`;
                }
              });
              
              comment += '\n---\n*Thresholds: Performance â‰¥95, Accessibility â‰¥95, Best Practices â‰¥95, SEO â‰¥95*';
              
              // Post comment to PR
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
